```{r}
#| label: setup
#| include: false

source(here::here("R", "_setup.R"))
```

<!-- badges: start -->
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![License: CC BY 4.0](https://img.shields.io/badge/License-CC_BY_4.0-lightgrey.svg)](https://creativecommons.org/licenses/by/4.0/)
<!-- badges: end -->

## Overview

This repository contains a data analysis exercise for the course [An Introduction to the R Programming Language](https://github.com/danielvartan/r-course).

The report investigates differences in ultra-processed food consumption among Brazilian children aged 2 to 4 in 2022. The analysis focuses on clusters B and D of the Revised Multidimensional Index for Sustainable Food Systems ([MISFS-R](https://doi.org/10.1002/sd.2376)).

## Question

This analysis seeks to address the following question:

::: {style="text-align: center; font-size: 1.1em; padding-top: 100px;"}
Was there a [**meaningful**]{.brand-red} difference in [**ultra-processed food consumption**]{.brand-red} among Brazilian children aged [**2 to 4**]{.brand-red} in [**2022**]{.brand-red} across the [**clusters B and D**]{.brand-red} of the Revised Multidimensional Index for Sustainable Food Systems ([MISFS-R](https://doi.org/10.1002/sd.2376))?
:::

## Methods

### Approach and Procedure Method

This study employed the hypothetical-deductive method, also known as the method of conjecture and refutation [@popper1979a, p. 164], as its problem-solving approach. Procedurally, it applied an enhanced version of Null Hypothesis Significance Testing (NHST), grounded on the original ideas of Neyman-Pearson framework for data testing [@neyman1928; @neyman1928a; @perezgonzalez2015].

The analysis was conducted using a [t-test for independent samples](https://en.wikipedia.org/wiki/Student%27s_t-test) alongside visual inspections of the data.

Additionally, a power analysis and effect-size estimation were performed to ensure the robustness and practical significance of the results.

### Source of Data/Information

The data used in this analysis were sourced from Brazil's Food and Nutrition Surveillance System ([SISVAN](https://sisaps.saude.gov.br/sisvan/)), regarding the dataset on ultra-processed food consumption [@sisvanb].

Only data from municipalities with **10 or more** monitored children were considered in the analysis.

### Data Wrangling

Data munging and analysis followed the data science workflow outlined by @wickham2023e, as illustrated in [@fig-wickham-at-al-2024-figure-1]. All processes were made using the R programming language [@rcoreteama], RStudio IDE [@positteama], and several R packages.

The [tidyverse](https://www.tidyverse.org/) and [rOpenSci](https://ropensci.org/) peer-reviewed package ecosystem and other R packages adherents of the tidy tools manifesto [@wickham2023c] were prioritized. All processes were made in order to provide result transparency and reproducibility.

::: {#fig-wickham-at-al-2024-figure-1}
![](images/wickham-at-al-2024-figure-1.png){width=75%}

[Source: Reproduced from @wickham2023e.]{.legend}

Data science workflow created by Wickham, Çetinkaya-Runde, and Grolemund.
:::

The Tidyverse [code style guide](https://style.tidyverse.org/) and [design principles](https://design.tidyverse.org/) were followed to ensure consistency and enhance readability.

All analyses are fully reproducible and can be rerun at any time. See the [README](https://github.com/sustentarea/gs-data-analysis-report-4/blob/main/README.md) file in the code repository to learn how to run them.

### Hypothesis Testing

We tested whether the means of ultra-processed food consumption among Brazilian children aged 2 to 4 in 2022 differed meaningfully across the clusters B and D of the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R).

To ensure practical significance, we applied a Minimum Effect Size (MES) criterion, following the original Neyman-Pearson framework for hypothesis testing [@neyman1928; @neyman1928a; @perezgonzalez2015]. The MES was set at Cohen's threshold for small effects (Cohen's $d$: $0.2$) [@cohen1988a]. Thus, a difference was considered meaningfully only if its effect-size exceeded the MES; otherwise, it was considered negligible.

The test was structured as follows:

- **Null Hypothesis** ($\text{H}_{0}$): Ultra-processed food consumption among Brazilian children aged 2 to 4 in 2022 does not differ meaningfully across MISFS-R clusters B and D, indicated by Cohen's $d$ effect-size statistic being smaller than $0.2$ (negligible) **or** by a non-significant t-test (with a Type I error probability ($\alpha$) of $0.05$).

- **Alternative Hypothesis** ($\text{H}_{a}$): Ultra-processed food consumption among Brazilian children aged 2 to 4 in 2022 differs meaningfully across MISFS-R clusters B and D, indicated by Cohen's $d$ effect-size statistic being greater or equal than $0.2$ (non-negligible) **and** by a significant t-test (with a Type I error probability ($\alpha$) of $0.05$).

Formally:

$$
\begin{cases}
\text{H}_{0}: \text{Cohen's} \ d < \text{MES} \quad \text{or} \quad \text{t-test is not significant} \ (\alpha \geq 0.05) \\
\text{H}_{a}: \text{Cohen's} \ d \geq \text{MES} \quad \text{and} \quad \text{t-test is significant} \ (\alpha < 0.05)
\end{cases}
$$

### Interpretation of Results

#### Revised Multidimensional Index for Sustainable Food Systems (MISFS-R)

MISFS is a multidimensional index designed to assess the sustainability of food systems at a subnational level in Brazil, incorporating local behaviors and practices. The MISFS-R is a revised version that introduces new indicators and a refined methodology ([@fig-norde-2023-figure-6]). For more details, see @carvalho2021a and @norde2023.

::: {#fig-norde-2023-figure-6}
![](images/norde-2023-figure-6.jpg){width=90%}

[Source: Reproduced from @norde2023.]{.legend}

Dendrogram for cluster analysis between Brazilian states considering all the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R) indicators and geographical location of each cluster.
:::

#### Pratical Significance

To ensure practical significance, we used Cohen's $d$ statistic small size benchmark as a reference. This statistic was analyzed considering a confidence interval of $95\%$.

We emphasize the need for the use of a MES while conducting hypothesis tests, since a p-value does not measure effect size; rather, it represents the conditional probability of observing the test statistic (or a more extreme value) given that the null hypothesis is true [@cohen1994; @wasserstein2016].

## Setting the Enviroment

```{r}
#| eval: false

library(broom)
library(cli)
library(clipr)
library(colorspace)
library(dplyr)
library(effectsize)
library(ggplot2)
library(ggspatial)
library(here)
library(janitor)
library(magrittr)
library(mgcViz)
library(pal) # gitlab.com/rpkg.dev/pal
library(patchwork)
library(psychometric)
library(ragg)
library(readr)
library(readxl)
library(rutils) # github.com/danielvartan/rutils
library(stringr)
library(summarytools)
library(tidyr)
```

```{r}
#| include: false

library(magrittr)
library(ggplot2)
library(summarytools)
```

## Importing and Tidying the Data

Source: SISVAN [Food Consumption](https://opendatasus.saude.gov.br/dataset/sisvan-estado-nutricional) dataset for ultra-processed food consumption of children between 2 to 4 years old (Sistema de Vigilância Alimentar e Nutricional, n.d.).

### Downloading the Data

```{r}
if (!dir.exists(here::here("data"))) dir.create("data")
file <- here::here("data", "sisvan-raw.xlsx")

paste0(
    "https://sisaps.saude.gov.br/sisvan/public/file/relatorios/",
    "consumo/2oumais/entre2a4anos/CONS_ULTRA.xlsx"
  ) |>
  curl::curl_download(file)
```

### Reading the Data

```{r}
#| output: false

data <- NULL

for (i in 2015:2022) {
  data_i <-
      here::here("data", "sisvan-raw.xlsx") |>
      readxl::read_xlsx(
        sheet = as.character(i),
        skip = 1,
        col_types = "text",
        col_names = FALSE
      ) |>
      dplyr::slice(-1)

  if (!i == 2022) data_i <- data_i |> dplyr::select(-1, -2)

  data_i <-
    data_i |>
    dplyr::rename_with(~ paste0("x", seq(length(.x)))) |>
    dplyr::mutate(year = i) |>
    dplyr::relocate(year)

  data <- dplyr::bind_rows(data, data_i)
}
```

### Tidying the Data

```{r}
data <-
  data |>
  dplyr::rename(
    state_abbrev = x1,
    municipality_code = x2,
    municipality_name = x3,
    n_upf = x4,
    n_upf_rel = x5,
    n_monitored = x6
  ) |>
  dplyr::mutate(
    municipality_code = as.integer(municipality_code),
    municipality_name = stringr::str_to_title(municipality_name),
    n_upf = as.integer(n_upf),
    n_monitored = as.integer(n_monitored)
  )
```

### Validating the Data

```{r}
data <-
  data |>
  dplyr::filter(
    !n_upf > n_monitored,
    n_monitored >= 10,
    !state_abbrev == "DF"
  ) |>
  tidyr::drop_na(n_upf, n_monitored) |>
  dplyr::mutate(n_upf_rel = n_upf / n_monitored)
```

### Transforming the Data

```{r}
data <-
  data |>
  dplyr::mutate(
    misfs = dplyr::case_when(
      state_abbrev %in% c(
        "AC", "GO", "MS", "MT", "RO", "TO"
      ) ~ "A",
      state_abbrev %in% c(
        "ES", "MG", "PR", "RJ", "RS", "SC", "SP"
      ) ~ "B",
      state_abbrev %in% c(
        "AL", "BA", "CE", "MA", "PB", "PE", "PI", "RN", "SE"
      ) ~ "C",
      state_abbrev %in% c(
        "AM", "AP", "PA", "RR"
      ) ~ "D",
    ),
    misfs = factor(misfs, levels = c("A", "B", "C", "D"))
  ) |>
  dplyr::relocate(misfs, .before = state_abbrev)
```

```{r}
data
```

```{r}
#| eval: false
#| include: false

data |> dplyr::sample_n(1000) |> View()
```

```{r}
#| eval: false
#| include: false

data |> dplyr::glimpse()
```

## Data Dictionary

- `year`: Year of the data collection (type: `integer`).
- `misfs`: Revised Multidimensional Index for Sustainable Food Systems (MISFS-R) cluster (type: `factor`).
- `state_abbrev`: State abbreviation (Federal Unit) (type: `character`).
- `municipality_code`: Municipality code (type: `integer`).
- `municipality_name`: Municipality name (type: `character`).
- `n_upf`: Number of children that consumed ultra-processed foods (UPF) (type: `integer`).
- `n_upf_rel`: Percentage of children that consumed ultra-processed foods (UPF) (type: `double`).
- `n_monitored`: Number of monitored children (type: `integer`).

## Checking SISVAN Cover

```{r}
brand_div_palette <- function(x) {
  brandr:::make_color_vector(
    n_prop = x,
    colors = c(
      get_brand_color("dark-red"),
      # get_brand_color("white"),
      get_brand_color_mix(
        position = 950,
        color_1 = "dark-red",
        color_2 = "dark-red-triadic-blue",
        alpha = 0.5
      ),
      get_brand_color("dark-red-triadic-blue")
    )
  )
}
```

```{r}
#| eval: false
#| include: false

plot <-
  data |>
  dplyr::mutate(sisvan_cover = sisvan_cover * 100) |>
  dplyr::filter(year == 2019) |>
  plotr::plot_brazil_municipality(
    col_fill = "sisvan_cover",
    comparable_areas = TRUE,
    transform = "identity",
    breaks = seq(0, 100, 25),
    reverse = FALSE,
    limits = c(0, 100),
    print = FALSE,
    palette = brand_div_palette
  ) +
  ggplot2::labs(
    title = "Year: 2019"
  )

plot |> print() |> rutils::shush()
```

```{r}
#| eval: false

# Run this chunk to produce the plots and the animation.

data |>
  dplyr::mutate(sisvan_cover = sisvan_cover * 100) |>
  plotr::animate_plot_brazil_municipality(
    col_fill = "sisvan_cover",
    col_group = "year",
    group_label = "Year",
    comparable_areas = TRUE
    suffix = NULL,
    width = 1344,
    height = 960,
    dpi = 150,
    transform = "identity",
    breaks = seq(0, 100, 25),
    reverse = FALSE,
    limits = c(0, 100),
    palette = brand_div_palette
  )
```

```{r}
#| eval: false
#| include: false

# Run this chunk to produce the panel-tabset for the plots.

tabset_panel_brazil_municipality(
  col = "sisvan_cover",
  caption = long_string(
      "
      Percentage of children under five monitored by Brazil's Food and
      Nutrition Surveillance System (SISVAN) across Brazil's
      historically comparable municipalities
      (minimum comparable areas [@ehrl2017]).
      "
  ),
  source = "Created by the authors based on data from @sisvana and @ibgel.",
  years = 2008:2019,
  heading = "###"
)
```

{{< include ./qmd/_panel-tabset-brazil-municipality-sisvan-cover.qmd >}}

## Checking Distributions

### General Distributions

```{r}
#| eval: false
#| include: false

# Run this chunk to produce the panel-tabset for the distributions.

data |>
  quartor:::tabset_panel_var_distribution(
    cols =
      names(data) |>
      stringr::str_subset("^municipality", negate = TRUE),
    jitter = FALSE,
    heading = "####"
  )
```

{{< include ./qmd/_panel-tabset-var-distribution.qmd >}}

### By MISFS-R Clusters

```{r}
categories <- c("A", "B", "C", "D")

for (i in categories) {
  i_data_name  <- paste0("data_misfs_", tolower(i))

  assign(
    i_data_name,
    data |> dplyr::filter(misf == i)
  )
}
```

```{r}
#| eval: false
#| include: false

# Run this chunk to produce the panel-tabset for the distributions.

data |>
  quartor:::tabset_panel_var_distribution_by_misfs(
    cols =
      names(data) |>
      stringr::str_subset("^municipality", negate = TRUE),
    jitter = FALSE,
    heading = "####"
  )
```

{{< include ./qmd/_panel-tabset-var-distribution-by-misfs.qmd >}}

## Checking Combined Distributions

## Assessing Power

## Modeling the Data

## Conclusion

Does the Standardized Precipitation Evapotranspiration Index (SPEI) significantly improve the prediction of childhood undernutrition in Brazilian municipalities?

## Acknowledgments

![](images/sustentarea-icon-rgb-150-dpi.png){style="width: 17.5%;"}

This analysis is part of the [Sustentarea](https://www.fsp.usp.br/sustentarea) Research and Extension Group's project: *Global syndemic: the impact of anthropogenic climate change on the health and nutrition of children under five years old attended by Brazil's public health system (SUS)*.

![](images/cnpq-logo.png){style="width: 30%;"}

This research was supported by the Conselho Nacional de Desenvolvimento Científico e Tecnológico - Brazil ([CNPq](https://www.gov.br/cnpq/)).

## How to Cite

To cite this work, please use the following format:

Vartanian, D, & Carvalho, A. M. (2025). *Global syndemic project data analysis: Report 4: Exploring potential differences in ultra-processed food consumption among Brazilian children aged 2 to 4 in 2022 across the clusters of the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R)*. Sustentarea Research and Extension Group at the University of São Paulo. https://sustentarea.github.io/gs-data-analysis-report-4

A BibTeX entry for LaTeX users is

```
@techreport{vartanian2025,
  title = {Global syndemic project data analysis: Report 4: Exploring potential differences in ultra-processed food consumption among Brazilian children aged 2 to 4 in 2022 across the clusters of the Revised Multidimensional Index for Sustainable Food Systems (MISFS-R)},
  author = {{Daniel Vartanian} and {Aline Martins de Carvalho}},
  year = {2025},
  address = {São Paulo},
  institution = {Sustentarea Research and Extension Group at the University of São Paulo},
  langid = {en},
  url = {https://sustentarea.github.io/gs-data-analysis-report-4}
}
```

## References {.unnumbered}

::: {#refs}
:::
